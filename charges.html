<!doctype html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Hello, Bootstrap Table!</title>



	<link href="https://code.jquery.com/ui/1.10.3/themes/redmond/jquery-ui.css" rel="stylesheet" media="screen">
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet">

	<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
	<link href="vendors/form-helpers/css/bootstrap-formhelpers.min.css" rel="stylesheet">
	<link href="vendors/select/bootstrap-select.min.css" rel="stylesheet">
	<link href="vendors/tags/css/bootstrap-tags.css" rel="stylesheet">

	<link href="css/valicatecss.css" rel="stylesheet">

	<link rel="stylesheet" href="css/styles.css">

	<link href="css/forms.css" rel="stylesheet">
</head>
<body>
<div class="page-content">
	<div class="row">



		<div class="col-md-12">

			<form class="form-horizontal" role="form">
				<div class="row">
					<div class="col-md-12">
						<div class="content-box-large">
<!--患者信息查询-->
							<div class="panel-heading">
								<div class="panel-title">患者信息查询</div>
							</div>
							<div class="panel-body">
								<div class="form-group">
									<label for="medRecID" class="col-sm-1 control-label"><span class="redSpan">*</span>病历号</label>
									<div class="col-sm-4">
										<input type="text"  class="form-control" name="medRecID" id="medRecID" placeholder="请输入病历号" required>
									</div>

									<div class="col-sm-1">
										<input id="search" type="button" value="Search" class="btn btn-primary">
									</div>
									<div class="col-sm-1">
										<button type="reset" class="btn btn-primary">&nbsp;Reset&nbsp;</button>
									</div>
								</div>
							</div>
<!--患者信息确认-->

							<div class="panel-heading">
								<div class="panel-title">患者信息确认</div>
							</div>
							<div class="panel-body">
								<div class="form-group">
									<label class="col-sm-1 control-label" for="name">姓 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 名</label>
									<div class="col-sm-2">
										<span class="form-control" id="name">姓&nbsp;&nbsp;&nbsp;名</span>
									</div>

									<label class="col-sm-1 col-sm-offset-1 control-label" for="identityID">身份证号</label>
									<div class="col-sm-5">
										<span class="form-control" id="identityID">身份证号</span>
									</div>
								</div>
								<div class="form-group">

									<label class="col-sm-1 control-label" for="address">家庭地址</label>
									<div class="col-sm-7">
										<span class="form-control" id="address">家庭地址</span>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>


			</form>


			<div class="row">
				<div class="col-md-12">
					<div class="content-box-large" >
						<div class="panel-heading">

							<div class="panel-title col-sm-3">患者消费信息</div>
<!--提交缴费按钮-->
							<div class="col-sm-1 col-sm-offset-7">
								<input id="charge_submit" type="button" value="Charge" class="btn btn-primary" >
							</div>
						</div>
						<br/>
						<br/>
<!--table-->
						<div class="panel-body">
							<table id="example" class="display" style="width:100%">
								<thead>
								<tr>
									<th>ID</th>
									<th>病历号</th>
									<th>挂号</th>
									<th>姓名</th>
									<th>项目名称</th>
									<th>单价</th>
									<th>数量</th>
									<th>开立时间</th>
									<th>状态</th>
								</tr>
								</thead>
								<tbody>

								</tbody>
								<tfoot>
								<tr>
									<th>ID</th>
									<th>病历号</th>
									<th>挂号</th>
									<th>姓名</th>
									<th>项目名称</th>
									<th>单价</th>
									<th>数量</th>
									<th>开立时间</th>
									<th>状态</th>
								</tr>
								</tfoot>
							</table>
						</div>

					</div>
				</div>


			</div>


<!--		发票信息模态框-->

			<div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
							<h4 class="modal-title" id="myModalLabel">发票信息（缴费）</h4>
						</div>
						<div class="modal-body">
							<form class="form-horizontal" role="form">
								<div class="row">
									<div class="col-md-12">
										<div class="content-box-large">
											<div class="form-group">
												<label for="invoiceCode" class="col-sm-2 control-label">发票号</label>
												<div class="col-sm-4">
													<input type="text"  class="form-control" name="invoiceCode" id="invoiceCode" placeholder="请输入发票号（可修改）" required>
												</div>
												<label for="modalMedRecID" class="col-sm-2 control-label">病历号</label>
												<div class="col-sm-4">
													<span class="form-control" id="modalMedRecID">病历号</span>
												</div>
											</div>

											<div class="form-group">
												<label for="patientName" class="col-sm-2 control-label">患者姓名</label>
												<div class="col-sm-4">
													<span class="form-control" id="patientName">患者姓名</span>

												</div>

												<label for="modalMedRecID" class="col-sm-2 control-label">支付方式</label>
												<div class="col-sm-4">
													<select class="form-control" id="chargeType" name="chargeType" required>
														<option >现金</option>
														<option >支付宝</option>
														<option >微信</option>
														<option >银联</option>
													</select>
												</div>
											</div>


											<div class="form-group">
												<label for="totalFee" class="col-sm-2 control-label">应收金额</label>
												<div class="col-sm-4">
													<span class="form-control" id="totalFee">应收金额</span>
												</div>

												<label for="chargeFeeActual" class="col-sm-2 control-label">实收金额</label>
												<div class="col-sm-4">
													<input type="text"  class="form-control" name="chargeFeeActual" id="chargeFeeActual" placeholder="请输入实收金额" required>
												</div>
											</div>

											<div class="form-group">
												<label for="chargeFee" class="col-sm-2 control-label">找零金额</label>
												<div class="col-sm-4">
													<span class="form-control" id="chargeFee">找零金额</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</form>

						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
							<button type="button" class="btn btn-primary" id="submit_invoice">提交</button>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal -->
			</div>

		</div>
	</div>


</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

<script src="js/token_cookie.js"></script>

<script>
	$(document).ready(function() {

		$("#chargeFeeActual").bind("input propertychange", function () {
			//$("#chargeFeeActual").val();
			var ta = Number($("#chargeFeeActual").val()-Number($('#totalFee').html()));
			$("#chargeFee").html(ta);
		});

		var patientInfo;

		var token = getCookie("my_token");

		//初始化列表


		var table = $('#example').DataTable({
			"paging":   true,
			"ordering": true,
			"info":     true,
			'searching':true,
			"ajax":"",
			"columns": [
				{ "data": "id" },
				{"data":"medRecID"},
				{ "data": "regID" },
				{ "data": "name" },
				{ "data": "itemName" },
				{ "data": "price" },
				{ "data": "number" },
				{"data":"setupTime"},
				{ "data": "status" }
			],
			"columnDefs": [
				{
					"targets": [ 0 ],
					"visible": false,
				}
			]
		});

		$("#charge_submit").click(function () {
			if(table.rows().data().length>0){
				$('#invoiceModal').modal('show');
				getTotal(patientInfo.medRecID);
			}else {
				alert("无缴费项")
			}
		});

		$("#medRecID").blur(function () {
			patientInfo = getPatientInfo($("#medRecID").val());
		});

		$('#search').click(function () {
			var medRecID = $("#medRecID").val();

			table.ajax.url("http://localhost:8082/api/his_charges/getCharges?medRecID="+medRecID).load();
		});

		$('#submit_invoice').click(function () {
			var account = $('#totalFee').html();
			var inVoiceCode = $('#invoiceCode').val();
			var data = (table.data());
			var list = new Array();
			$.each(data,function (index,value) {
				list.push(value.id);
			});
			alert(JSON.stringify(list))
			var inVoiceID = addInvoice(token,patientInfo,inVoiceCode,account);
			var chargeData = {
				list:list,
				inVoiceID:inVoiceID
			};
			alert(JSON.stringify(chargeData))
			pay(chargeData,token);
			$('#invoiceModal').modal('hide');
			table.ajax.url("http://localhost:8082/api/his_charges/getCharges?medRecID="+patientInfo.medRecID).load();

		});


	} );

	function getPatientInfo(medRecID) {
		var patientInfo;
		$.ajax({
			type:'get',
			url:"http://localhost:8082/api/his_reg/getPatient?medRecID="+medRecID,
			async:false,
			success:function (data) {
				if(data.code===0){
					var jsonData = data.data;
					patientInfo = jsonData;
					$('#address').html(jsonData.address);
					$('#identityID').html(jsonData.identityID);
					$('#name').html(jsonData.name);
					$('#modalMedRecID').html(medRecID);
					$("#patientName").html(jsonData.name);
				}else{
					alert("没有此患者信息");
				}

			}
		});
		return patientInfo;
	}

	function getTotal(medRecID) {
		$.ajax({
			type:'get',
			url:"http://localhost:8082/api/his_charges/getTotal?medRecID="+medRecID,
			success:function (data) {
				if(data.code===0){
					var jsonData = data.data;
					$("#totalFee").html(Number(jsonData));
				}else{
					alert("没有此患者信息");
				}

			}
		})
	}

	function addInvoice(token,patient,inVoiceCode,account) {

		var medRecID =patient.medRecID;
		alert(medRecID)
		var inVoiceID;
		alert('http://localhost:8082/api/his_charges/addInvoice?invoiceCode='+inVoiceCode+'&medRecID='+medRecID)
		$.ajax({
			type:'get',
			async: false,
			url:'http://localhost:8082/api/his_charges/addInvoice?invoiceCode='+inVoiceCode+'&medRecID='+medRecID,
			contentType: 'application/json;charset=utf-8',
			beforeSend: function (xhr) {
				xhr.setRequestHeader("Authorization", token);
			},
			success: function (data) {
				if (data.code === 0) {
					var jsonData = data.data;
					inVoiceID = jsonData.id;
					console.log(JSON.stringify(data));
					//alert(data.msg);
				} else {
					alert(data.msg);
				}
			}

		});

		return inVoiceID;
	}

	function pay(chargesdata,token) {
		$.ajax({
			type:'post',
			async: false,
			data:JSON.stringify(chargesdata),
			url:'http://localhost:8082/api/his_charges/paycharge',
			contentType: 'application/json;charset=utf-8',
			beforeSend: function (xhr) {
				xhr.setRequestHeader("Authorization", token);
			},
			success: function (data) {
				if (data.code === 0) {
					var jsonData = data.data;
					console.log(JSON.stringify(data));
					alert(data.msg);
				} else {
					alert(data.msg);
				}
			}

		});
	}


</script>

</body>
</html>
